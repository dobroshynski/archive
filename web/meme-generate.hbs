<!-- script automatically loaded and executed to generate the meme -->
<html>
<header>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
</header>

<body>
  <canvas id="canvas"></canvas>
  <div class="userID" id="{{id}}"> </div>
  <script>
    document.addEventListener("DOMContentLoaded", main);

    function handleServerResponse() {
      if(this.responseText) {
        console.log(this.responseText);
      }
    }

    function handleError() {
      console.log("ERROR WITH AJAX CALL");
    }

    function wrapText(context, text, x, y, maxWidth, spacing) {
      var words = text.split(' ');
      var line = '';

      for(var n = 0; n < words.length; n++) {
        var testLine = line + words[n] + ' ';
        var metrics = context.measureText(testLine);
        var testWidth = metrics.width;
        if(testWidth > maxWidth && n > 0) {
          context.fillText(line, x, y);
          line = words[n] + ' ';
          y += spacing;
        } else {
          line = testLine;
        }
      }
      context.fillText(line, x, y);
    }

    function calculateFontForCharacters(numberOfCharacters) {
      var scale = 1.1;
      return 190 * Math.pow(numberOfCharacters, -0.4432) * scale;
    }

    function handleData() {
      var parsed = JSON.parse(this.responseText);
      var paragraphList = parsed.list;

      var userID = parsed.id;

      var text = paragraphList[0];
      var text2 = paragraphList[1];
      var text3 = paragraphList[2];
      var text4 = paragraphList[3];

      var canvas = document.getElementById('canvas');
      var ctx = canvas.getContext('2d');

      canvas.width = 857;
      canvas.height = 1202;

      var img = new Image();
      img.src = '/images/meme-template.jpg';

      img.onload = function(){
        ctx.drawImage(img,0,0);

        // fill in the image with text and align
        var maxWidth = 400;

        // set offset calculation
        ctx.font = '16pt Arial';
        var offset = ctx.measureText('M').width;

        // blurb 1 calculations
        var numberOfCharacters = text.length;
        var fontCalculation = calculateFontForCharacters(numberOfCharacters);
        var spacingCalculation = fontCalculation * 1.5;

        ctx.font = '' + fontCalculation + 'pt Arial';
        offset = ctx.measureText('M').width;

        var x1 = 10;
        var y1 = 10 + offset;
        wrapText(ctx, text, x1, y1, maxWidth, spacingCalculation);

        // reset offset calculation
        ctx.font = '16pt Arial';
        offset = ctx.measureText('M').width;

        // blurb 2 calculations
        numberOfCharacters = text2.length;
        fontCalculation = calculateFontForCharacters(numberOfCharacters);
        spacingCalculation = fontCalculation * 1.5;

        ctx.font = '' + fontCalculation + 'pt Arial';

        var x2 = 10;
        var y2 = 300 + offset * 2;
        wrapText(ctx, text2, x2, y2, maxWidth, spacingCalculation);

        // reset offset calculation
        ctx.font = '16pt Arial';
        offset = ctx.measureText('M').width;

        // blurb 3 calculations
        numberOfCharacters = text3.length;
        fontCalculation = calculateFontForCharacters(numberOfCharacters);
        spacingCalculation = fontCalculation * 1.5;

        ctx.font = '' + fontCalculation + 'pt Arial';

        var x3 = 10;
        var y3 = 620 + offset * 2;
        wrapText(ctx, text3, x3, y3, maxWidth, spacingCalculation);

        // reset offset calculation
        ctx.font = '16pt Arial';
        offset = ctx.measureText('M').width;

        // blurb 4 calculations
        numberOfCharacters = text4.length;
        fontCalculation = calculateFontForCharacters(numberOfCharacters);
        spacingCalculation = fontCalculation * 1.5;

        ctx.font = '' + fontCalculation + 'pt Arial';

        var x4 = 10;
        var y4 = 900 + offset * 2;
        wrapText(ctx, text4, x4, y4, maxWidth, spacingCalculation);

        var imageBufferedData = document.getElementById("canvas").toDataURL();

        // AJAX call with JQuery to send the image data to server
        (function($) {
          var data = {};
          data.data = imageBufferedData;

          $.post(('/handle/image/data/' + userID), data, handleServerResponse);
        })(jQuery);
      };
    }

    function main() {
      var userID = document.getElementsByClassName("userID")[0].id;
      var req = new XMLHttpRequest();
  		var url = "/get/data/" + userID;
  		req.open('GET',url,true);
  		req.addEventListener('load',handleData);
  		req.addEventListener('error',handleError);
  		req.send();
    }
  </script>
</body>
</html>
